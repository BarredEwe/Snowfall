name: Release (GitHub + Homebrew + App Store)

on:
    release:
    types: [published]

permissions:
    contents: write

env:
    APP_NAME: Snowfall
    XCODEPROJ: Snowfall.xcodeproj
    SCHEME: SnowfallApp

jobs:
    build-and-attach-zip:
    name: Build ZIP for GitHub & Homebrew
    runs-on: macos-latest
    steps:
        - name: Checkout
        uses: actions/checkout@v4
        
        - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
            xcode-version: latest-stable
        
        - name: Build and create ZIP (Developer ID)
        run: |
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ Developer ID Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒÑŽ Ð´Ð»Ñ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð²Ð½Ðµ App Store
          make archive
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ZIP ÑÐ¾Ð·Ð´Ð°Ð½
          if [ ! -f "build/Snowfall.zip" ]; then
            echo "âŒ ZIP file not found!"
            exit 1
          fi
          
          echo "âœ… ZIP created: build/Snowfall.zip"
          ls -lh build/Snowfall.zip
          unzip -l build/Snowfall.zip
        
        - name: Attach ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
            tag_name: ${{ github.event.release.tag_name }}
            files: |
            build/Snowfall.zip
    
    update-homebrew:
    name: Update Homebrew Cask
    needs: build-and-attach-zip
    runs-on: macos-latest
    steps:
        - name: Wait for ZIP to be available
        run: sleep 10
        
        - name: Update Homebrew Cask
        uses: macauley/action-homebrew-bump-cask@v1
        with:
            token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
            tap: BarredEwe/homebrew-cask
            cask: snowfall
    
    submit-appstore:
    name: Submit to App Store
    needs: build-and-attach-zip
    runs-on: macos-latest
    # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´Ð»Ñ pre-release Ð¸ test Ð²ÐµÑ€ÑÐ¸Ð¹
    if: github.event.release.prerelease != true && !contains(github.event.release.tag_name, 'test')
    steps:
        - name: Checkout
        uses: actions/checkout@v4
        
        - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
            xcode-version: latest-stable
        
        - name: Prepare version and release notes
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          
          python3 - <<'PY'
          import json
          import re
          
          event = json.load(open("${{ github.event_path }}", "r", encoding="utf-8"))
          body = (event["release"].get("body") or "").strip()
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° markdown
          body = re.sub(r'\[([^\]]+)\]\([^\)]+\)', r'\1', body)
          body = re.sub(r'[#*`_]', '', body)
          body = re.sub(r'\n{3,}', '\n\n', body)
          
          if len(body) > 4000:
              body = body[:3997] + "..."
          
          if not body.strip():
              body = "Bug fixes and performance improvements"
          
          with open("release_notes.txt", "w", encoding="utf-8") as f:
              f.write(body)
          PY
          
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ“ Release notes:"
          cat release_notes.txt
        
        - name: Import signing certificate
        run: |
          echo "${{ secrets.CERT_P12_BASE64 }}" | base64 --decode > cert.p12
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security import cert.p12 -k build.keychain -P "${{ secrets.CERT_P12_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
        
        - name: Archive for App Store
        run: |
            xcodebuild \
            -project "${{ env.XCODEPROJ }}" \
            -scheme "${{ env.SCHEME }}" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -archivePath build/AppStore.xcarchive \
            clean archive
        
        - name: Export PKG for App Store
        run: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ExportOptions Ð´Ð»Ñ App Store
          xcodebuild -exportArchive \
            -archivePath build/AppStore.xcarchive \
            -exportPath build/appstore \
            -exportOptionsPlist ExportOptionsAppStore.plist
          
          # ÐÐ°Ð¹Ñ‚Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ PKG
          PKG_PATH="$(find build/appstore -name '*.pkg' | head -n 1)"
          
          if [ -z "$PKG_PATH" ]; then
            echo "âŒ PKG not found!"
            find build/appstore -type f
            exit 1
          fi
          
          echo "PKG_PATH=$PKG_PATH" >> "$GITHUB_ENV"
          echo "âœ… PKG created: $PKG_PATH"
          ls -lh "$PKG_PATH"
        
        - name: Install fastlane
        run: sudo gem install fastlane -N
    
        - name: Upload to App Store Connect
            env:
                FASTLANE_USER: ${{ secrets.APPLE_ID }}
                FASTLANE_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
            run: |
                fastlane deliver \
                  --platform macos \
                  --pkg "$PKG_PATH" \
                  --skip_screenshots \
                  --skip_metadata \
                  --force
