name: Release (GitHub + Homebrew + App Store)

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  APP_NAME: Snowfall
  XCODEPROJ: Snowfall.xcodeproj
  SCHEME: SnowfallApp

jobs:
  build-and-attach-zip:
    name: Build ZIP for GitHub & Homebrew
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build without code signing
        run: |
          mkdir -p build/export
          
          # Archive Ð±ÐµÐ· Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸
          xcodebuild \
            -scheme SnowfallApp \
            -configuration Release \
            -archivePath build/Snowfall.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .app Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð¸Ð· Ð°Ñ€Ñ…Ð¸Ð²Ð° (Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ exportArchive)
          cp -R build/Snowfall.xcarchive/Products/Applications/SnowfallApp.app build/export/
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ZIP
          cd build/export
          zip -r ../Snowfall.zip SnowfallApp.app
          cd ../..
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°
          if [ ! -f "build/Snowfall.zip" ]; then
            echo "âŒ ZIP file not found!"
            exit 1
          fi
          
          echo "âœ… ZIP created: build/Snowfall.zip"
          ls -lh build/Snowfall.zip
          unzip -l build/Snowfall.zip

      - name: Attach ZIP to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: build/Snowfall.zip

  update-homebrew:
    name: Update Homebrew Cask
    needs: build-and-attach-zip
    runs-on: macos-latest
    steps:
      - name: Wait for ZIP to be available
        run: sleep 10

      - name: Update Homebrew Cask
        uses: macauley/action-homebrew-bump-cask@v1
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          tap: BarredEwe/homebrew-cask
          cask: snowfall

  submit-appstore:
    name: Submit to App Store
    needs: build-and-attach-zip
    runs-on: macos-latest
    if: github.event.release.prerelease != true && !contains(github.event.release.tag_name, 'test')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Prepare version and release notes
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          
          python3 - <<'PY'
          import json
          import re
          
          event = json.load(open("${{ github.event_path }}", "r", encoding="utf-8"))
          body = (event["release"].get("body") or "").strip()
          
          body = re.sub(r'\[([^\]]+)\]\([^\)]+\)', r'\1', body)
          body = re.sub(r'[#*`_]', '', body)
          body = re.sub(r'\n{3,}', '\n\n', body)
          
          if len(body) > 4000:
              body = body[:3997] + "..."
          
          if not body.strip():
              body = "Bug fixes and performance improvements"
          
          with open("release_notes.txt", "w", encoding="utf-8") as f:
              f.write(body)
          PY
          
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ“ Release notes:"
          cat release_notes.txt

      - name: Import signing certificate
        run: |
          echo "${{ secrets.CERT_P12_BASE64 }}" | base64 --decode > cert.p12
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security import cert.p12 -k build.keychain -P "${{ secrets.CERT_P12_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Archive for App Store
        run: |
          xcodebuild \
            -project "${{ env.XCODEPROJ }}" \
            -scheme "${{ env.SCHEME }}" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -archivePath build/AppStore.xcarchive \
            archive

      - name: Export PKG for App Store
        run: |
          xcodebuild -exportArchive \
            -archivePath build/AppStore.xcarchive \
            -exportPath build/appstore \
            -exportOptionsPlist ExportOptionsAppStore.plist

          PKG_PATH="$(find build/appstore -name '*.pkg' | head -n 1)"
          
          if [ -z "$PKG_PATH" ]; then
            echo "âŒ PKG not found!"
            find build/appstore -type f
            exit 1
          fi
          
          echo "PKG_PATH=$PKG_PATH" >> "$GITHUB_ENV"
          echo "âœ… PKG created: $PKG_PATH"
          ls -lh "$PKG_PATH"

      - name: Upload to App Store Connect
        run: |
          xcrun altool --upload-app \
            --type macos \
            --file "$PKG_PATH" \
            --username "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APP_SPECIFIC_PASSWORD }}" \
            --asc-provider "${{ secrets.TEAM_ID }}"
